name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend:
    name: Backend Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy

      - name: Run Ruff linting
        id: ruff-lint
        continue-on-error: true
        run: ruff check backend/ --output-format=github

      - name: Run Ruff format check
        id: ruff-format
        continue-on-error: true
        run: ruff format --check backend/

      - name: Run mypy type checking
        id: mypy
        continue-on-error: true
        run: mypy backend/ --ignore-missing-imports

      - name: Set up test database
        run: mkdir -p data

      - name: Run database migrations
        run: alembic upgrade head

      - name: Run pytest
        id: pytest
        continue-on-error: true
        run: pytest backend/tests/ -v --cov=backend --cov-report=term-missing

      - name: Check for failures
        if: steps.ruff-lint.outcome == 'failure' || steps.ruff-format.outcome == 'failure' || steps.mypy.outcome == 'failure' || steps.pytest.outcome == 'failure'
        run: |
          echo "One or more checks failed:"
          echo "  Ruff lint: ${{ steps.ruff-lint.outcome }}"
          echo "  Ruff format: ${{ steps.ruff-format.outcome }}"
          echo "  mypy: ${{ steps.mypy.outcome }}"
          echo "  pytest: ${{ steps.pytest.outcome }}"
          exit 1

  frontend:
    name: Frontend Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run ESLint
        id: eslint
        continue-on-error: true
        working-directory: frontend
        run: npm run lint

      - name: Run Prettier check
        id: prettier
        continue-on-error: true
        working-directory: frontend
        run: npx prettier --check "src/**/*.{ts,tsx,json,css}"

      - name: Run TypeScript build
        id: tsc
        continue-on-error: true
        working-directory: frontend
        run: npm run build

      - name: Run tests
        id: vitest
        continue-on-error: true
        working-directory: frontend
        run: npm test -- --run

      - name: Check for failures
        if: steps.eslint.outcome == 'failure' || steps.prettier.outcome == 'failure' || steps.tsc.outcome == 'failure' || steps.vitest.outcome == 'failure'
        run: |
          echo "One or more checks failed:"
          echo "  ESLint: ${{ steps.eslint.outcome }}"
          echo "  Prettier: ${{ steps.prettier.outcome }}"
          echo "  TypeScript: ${{ steps.tsc.outcome }}"
          echo "  Vitest: ${{ steps.vitest.outcome }}"
          exit 1
